# Remove common files in snaps

This script searches the files installed with the "stage-packages:" statement
and removes all those that are already available in other base snaps (like
core20/core22, or gnome-XX...). This allows to greatly reduce the final size
of the snap.

## Rationale

When a .deb package is installed because it is listed in the "stage-packages"
statement, all their dependencies are installed too. This means that, in a
lot of cases, there will be a lot of files duplicated between the snap and the
base snaps (like core22, or gnome-42-2204).

For example, let's say that our snap installs the stage package X; but that
package depends on package Y, and this later also depends on Z. This means that
X, Y and Z will be installed in our stage.

Now, if, let's say, the core22 snap already contains the Z package, that
means that the files contained in Z will be duplicated in both our snap and
core22.

Or if gnome-42-2204 already contains the Y package (and, thus, also the Z one),
that means that the files contained in Y and Z will be duplicated in both our
snap and gnome-42-2204.

The result is that we have duplicated files in our snap; files that aren't
needed and that occupy precious space. This is what this script solves.

Previously, a bash script like this one was used for this task:

    build-snaps: [core22, gtk-common-themes, gnome-42-2204]
    override-prime: |
      set -eux
      for snap in "core22" "gtk-common-themes" "gnome-42-2204"; do
        cd "/snap/$snap/current" && find . -type f,l -name *.so.* -exec rm -f "$CRAFT_PRIME/{}" \;
      done

This script has several flaws:

* It searches all the base snaps (core22, gtk-common-themes and gnome-42-2204)
  to check if there is a duplicate file in PRIME. This is very slow because it
  has to search for a lot of files (about 14 thousands in core22, 20 thousands
  in gnome-42-2204, and 76 thousands in gtk-common-themes)  and execute a rm
  command for each matching file.
* It is executed at the end of the staging process, after all the parts of the
  snap have been built and staged. This means that it can delete accidentally
  files that were overwritten during the building, thus removing the new and
  desired versions and using the old ones (for example, if the snap compiles a
  more recent version of a library shipped in core or gnome-contents snaps, but
  with the same major version).
* It only searches for duplicated library files, but donâ€™t remove other duplicate
  files, like documentation, icons...

This python script, instead, is run after the stage .deb packages have been
installed in CRAFT_PART_INSTALL, but before the part has been built. This allows
to safely remove any duplicate files without risking to delete something created
by the part. Also, it searches in the opposite way: checks each file in
CRAFT_PART_INSTALL to see if it exists in any of the specified base snaps, which
is much faster because the number of files is smaller. Also, it does any deletion
in-script, instead of calling an external program ('rm' in the old script), which
is always slower because it has to launch a new process, read and link the
binary... Thanks to these two changes, now it is possible to search for all the
duplicate files (not only libraries) and remove them safely.

The only inconvenient of this script is that it must be run in all and each part
that installs stage packages.

## How to use it

Let's say that we have this part:

    parts:
      [...]

      mypreciouspart:
        source: ...
        stage-packages:
          - package1
          - package2
          - package3
        ...

To use this script, just change it to:

    parts:
      [...]

      mypreciouspart:
        source: ...
        stage-packages:
          - package1
          - package2
          - package3
        ...
        build-snaps: [core22, gtk-common-themes, gnome-42-2204]
        override-build: |
          $CRAFT_PROJECT_DIR/snapbuildtools/remove_common.py
          craftctl default

This will remove all the files installed from package1, package2,... that are already
available in core22, gtk-common-themes and gnome-42-2204. Also, since it is run before
building anything, it will remove only the duplicated files from the .deb packages, but
not any file with the same name generated by the source code.

If you are already using *override-build*, just add

    $CRAFT_PROJECT_DIR/snapbuildtools/remove_common.py

as the first command.

Of course, if you snap uses core20 and/or gnome-3-38-2004, or others, you have to replace
them in the lists.

By default, the script will scan the *snapcraft.yaml* file for all the *build-snaps*
entries in it, but it is possible to override this by manually putting the list of snaps
in the command line (this is a must to preserve compatibility with the old behavior).

You can also add the *-v* argument to have *verbose* output of which files are being removed.

Also, it is possible to add *-e path1/\* path2/\*.so ...* to exclude several paths or
files from being checked and/or removed.

Finally, you can add *-m base_snap1:path_piece1 base_snap2:path_piece2* to compare files
from *SNAP_BEING_BUILT/path_piece1/...* with */snap/base_snap1/...*, etc. This is useful
for snaps like *gtk-common-themes*, because the themes are stored directly at *share/...*
instead of *usr/share/...*, which prevents to find duplicated icons, sounds and themes.
Instead, by adding *-m gtk-common-themes:usr*, this problem is fixed. In fact, due to the
commonality of this case, *gtk-common-themes:usr* is added by default in the case that
it is already in the list of snaps.

Remember to add this in *each* part that has *stage-packages*. Parts without stage
packages don't need this. The *build-snaps* statement only needs to be put once, so it's better
to put it in the *snapbuildtools* part (the one added at the beginning for installing these
tools).
